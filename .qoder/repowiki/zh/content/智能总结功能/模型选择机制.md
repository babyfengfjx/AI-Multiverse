# 模型选择机制

<cite>
**本文档引用的文件**
- [manifest.json](file://manifest.json)
- [config.js](file://src/config.js)
- [background.js](file://src/background.js)
- [popup.js](file://src/popup/popup.js)
- [sidepanel.js](file://src/sidepanel/sidepanel.js)
- [content.js](file://src/content/content.js)
- [popup.html](file://src/popup/popup.html)
- [sidepanel.html](file://src/sidepanel/sidepanel.html)
- [i18n.js](file://src/i18n.js)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

AI Multiverse Chat 是一个Chrome扩展程序，支持同时向多个AI聊天平台发送消息。该项目的核心机制是模型选择系统，它允许用户选择Gemini、Grok、Kimi、DeepSeek、ChatGPT、通义千问和腾讯元宝等AI模型，并提供统一的配置管理和状态同步。

该系统通过配置驱动的方式管理不同AI平台的差异，包括选择器策略、发送方法、文件上传支持等特性。系统采用分层架构设计，确保了良好的可维护性和扩展性。

## 项目结构

项目采用模块化设计，主要包含以下核心目录：

```mermaid
graph TB
subgraph "扩展根目录"
Manifest[manifest.json]
Icons[icons/]
end
subgraph "源代码结构"
Config[src/config.js]
Background[src/background.js]
subgraph "用户界面"
Popup[src/popup/]
Sidepanel[src/sidepanel/]
end
subgraph "内容脚本"
Content[src/content/content.js]
end
subgraph "国际化"
I18n[src/i18n.js]
end
end
Manifest --> Background
Background --> Content
Popup --> Background
Sidepanel --> Background
Config --> Background
Config --> Content
```

**图表来源**
- [manifest.json](file://manifest.json#L1-L79)
- [config.js](file://src/config.js#L1-L204)

**节来源**
- [README.md](file://README.md#L20-L29)

## 核心组件

### 配置管理系统

系统通过集中式配置管理所有支持的AI模型，每个模型都有详细的配置参数：

| 配置项 | 描述 | 示例值 |
|--------|------|--------|
| `name` | 模型显示名称 | 'Gemini' |
| `icon` | 图标路径 | 'icons/gemini.svg' |
| `baseUrl` | 基础URL | 'https://gemini.google.com/app' |
| `selectors` | DOM选择器集合 | 包含input、button、response等 |
| `fillMethod` | 输入填充方法 | 'main-world' 或 'content-script' |
| `sendMethod` | 发送方法 | 'button'、'enter' 或 'form' |
| `supportsFiles` | 是否支持文件上传 | true/false |
| `supportedFileTypes` | 支持的文件类型 | 数组形式 |

### 模型选择界面

系统提供两种用户界面进行模型选择：

1. **弹出窗口界面** (`src/popup/popup.html`)
   - 简化的模型选择界面
   - 适合快速发送消息
   - 默认勾选所有模型

2. **侧边栏界面** (`src/sidepanel/sidepanel.html`)
   - 功能完整的对话管理界面
   - 支持响应查看、历史记录、文件上传
   - 模态导航系统

**节来源**
- [config.js](file://src/config.js#L5-L199)
- [popup.html](file://src/popup/popup.html#L16-L33)
- [sidepanel.html](file://src/sidepanel/sidepanel.html#L193-L246)

## 架构概览

系统采用分层架构设计，确保各组件职责明确：

```mermaid
graph TB
subgraph "用户交互层"
PopupUI[弹出窗口UI]
SidepanelUI[侧边栏UI]
I18nUI[国际化支持]
end
subgraph "业务逻辑层"
Background[后台进程]
ConfigMgr[配置管理器]
SelectionMgr[选择管理器]
end
subgraph "内容脚本层"
ContentScript[内容脚本]
SelectorEngine[选择器引擎]
UploadEngine[上传引擎]
end
subgraph "AI平台层"
Gemini[Gemini]
Grok[Grok]
Kimi[Kimi]
DeepSeek[DeepSeek]
ChatGPT[ChatGPT]
Qwen[通义千问]
Yuanbao[腾讯元宝]
end
PopupUI --> Background
SidepanelUI --> Background
I18nUI --> Background
Background --> ContentScript
ConfigMgr --> Background
SelectionMgr --> Background
ContentScript --> SelectorEngine
ContentScript --> UploadEngine
Background --> Gemini
Background --> Grok
Background --> Kimi
Background --> DeepSeek
Background --> ChatGPT
Background --> Qwen
Background --> Yuanbao
```

**图表来源**
- [background.js](file://src/background.js#L1-L1028)
- [content.js](file://src/content/content.js#L1-L941)
- [config.js](file://src/config.js#L1-L204)

## 详细组件分析

### 配置系统分析

#### 模型配置结构

每个AI模型的配置包含以下关键要素：

```mermaid
classDiagram
class AIConfig {
+string name
+string icon
+string urlPattern
+string baseUrl
+Selectors selectors
+string fillMethod
+string sendMethod
+boolean supportsFiles
+array supportedFileTypes
}
class Selectors {
+array input
+array button
+array response
+array fileUploadButton
+array fileUploadInput
}
class GeminiConfig {
+string name = "Gemini"
+string icon = "icons/gemini.svg"
+string urlPattern = "* : //gemini.google.com/*"
+string baseUrl = "https : //gemini.google.com/app"
+string fillMethod = "main-world"
+string sendMethod = "button"
+boolean supportsFiles = true
}
AIConfig --> Selectors
GeminiConfig --|> AIConfig
```

**图表来源**
- [config.js](file://src/config.js#L5-L22)
- [config.js](file://src/config.js#L11-L17)

#### 模型配置差异

| 模型 | 填充方法 | 发送方法 | 文件支持 | 特殊配置 |
|------|----------|----------|----------|----------|
| Gemini | main-world | button | ✅ | 支持多类型文件 |
| Grok | main-world | button | ✅ | 支持图片和PDF |
| Kimi | content-script | button | ✅ | 避免重复事件 |
| DeepSeek | main-world | enter | ✅ | 使用Enter键提交 |
| ChatGPT | main-world | button | ✅ | 支持多种文件类型 |
| 通义千问 | main-world | enter | ✅ | 使用Enter键提交 |
| 腾讯元宝 | main-world | button | ✅ | 支持图片和文档 |

**节来源**
- [config.js](file://src/config.js#L6-L199)

### 选择管理器

#### 用户界面选择

```mermaid
sequenceDiagram
participant User as 用户
participant Popup as 弹出窗口
participant Storage as 本地存储
participant Background as 后台进程
User->>Popup : 选择AI模型
Popup->>Storage : 保存选择状态
Popup->>Background : 发送消息
Background->>Background : 处理选择列表
Background->>Background : 广播到各模型
Background-->>Popup : 返回状态更新
Popup-->>User : 显示发送结果
```

**图表来源**
- [popup.js](file://src/popup/popup.js#L16-L45)
- [sidepanel.js](file://src/sidepanel/sidepanel.js#L1314-L1341)

#### 侧边栏模型选择

侧边栏提供更丰富的模型选择体验：

1. **模态选择器** (`src/sidepanel/sidepanel.html`)
   - 网格布局展示所有模型
   - 图标和名称显示
   - 实时状态指示

2. **状态管理** (`src/sidepanel/sidepanel.js`)
   - 选择计数徽章
   - 本地存储持久化
   - 实时状态更新

**节来源**
- [sidepanel.js](file://src/sidepanel/sidepanel.js#L391-L408)
- [sidepanel.js](file://src/sidepanel/sidepanel.js#L1314-L1341)

### 内容脚本执行引擎

#### 主世界填充机制

```mermaid
flowchart TD
Start([开始填充]) --> DetectPlatform[检测平台类型]
DetectPlatform --> CheckMethod{填充方法}
CheckMethod --> |main-world| MainWorld[主世界填充]
CheckMethod --> |content-script| ContentScript[内容脚本填充]
MainWorld --> FindElement[查找目标元素]
FindElement --> FillText[填充文本内容]
FillText --> TriggerEvents[触发输入事件]
TriggerEvents --> End([填充完成])
ContentScript --> FocusElement[聚焦元素]
FocusElement --> ClearContent[清除内容]
ClearContent --> InsertText[插入文本]
InsertText --> End
```

**图表来源**
- [content.js](file://src/content/content.js#L323-L418)
- [background.js](file://src/background.js#L379-L526)

#### 发送机制

不同模型采用不同的发送策略：

| 模型 | 发送方法 | 行为描述 |
|------|----------|----------|
| Gemini | button | 点击发送按钮 |
| Grok | button | 点击发送按钮 |
| Kimi | button | 点击发送按钮（避免Enter回退） |
| DeepSeek | enter | 按Enter键提交 |
| ChatGPT | button | 点击发送按钮 |
| 通义千问 | enter | 按Enter键提交 |
| 腾讯元宝 | button | 点击发送按钮 |

**节来源**
- [content.js](file://src/content/content.js#L466-L565)

### 文件上传处理

#### 上传策略

```mermaid
flowchart TD
Start([开始上传]) --> CheckSupport{支持文件上传?}
CheckSupport --> |否| EndFail[返回不支持]
CheckSupport --> |是| FilterFiles[过滤支持的文件]
FilterFiles --> UploadLoop[逐个上传循环]
UploadLoop --> UploadSingle[上传单个文件]
UploadSingle --> Success{上传成功?}
Success --> |是| NextFile[处理下一个文件]
Success --> |否| Retry{重试次数<3?}
Retry --> |是| UploadSingle
Retry --> |否| UploadError[上传失败]
NextFile --> UploadLoop
UploadLoop --> EndSuccess[上传完成]
UploadError --> EndFail
```

**图表来源**
- [content.js](file://src/content/content.js#L616-L742)

#### 文件类型支持

| 模型 | 支持的文件类型 | 限制 |
|------|----------------|------|
| Gemini | image/*, .pdf, .txt, .doc, .docx | 10MB/文件 |
| Grok | image/*, .pdf, .txt | 10MB/文件 |
| Kimi | image/*, .pdf, .txt, .doc, .docx, .md, .json, .csv | 10MB/文件 |
| DeepSeek | image/* | 10MB/文件 |
| ChatGPT | image/*, .pdf, .txt, .md, .json, .csv, .py, .js | 10MB/文件 |
| 通义千问 | .pdf, .doc, .docx, .txt, .md, .json, .csv, image/* | 10MB/文件 |
| 腾讯元宝 | image/*, .pdf, .doc, .docx, .txt, .md | 10MB/文件 |

**节来源**
- [config.js](file://src/config.js#L21-L199)

## 依赖关系分析

### 外部依赖

系统依赖以下外部资源：

```mermaid
graph LR
subgraph "扩展权限"
Manifest[manifest.json]
Permissions[权限声明]
end
subgraph "第三方库"
Marked[marked.js]
Highlight[highlight.js]
Purify[DOMPurify]
end
subgraph "AI平台"
Gemini[gemini.google.com]
Grok[grok.com]
Kimi[kimi.moonshot.cn]
DeepSeek[chat.deepseek.com]
ChatGPT[chatgpt.com]
Qwen[chat.qwen.ai]
Yuanbao[yuanbao.tencent.com]
end
Manifest --> Permissions
Sidepanel --> Marked
Sidepanel --> Highlight
Sidepanel --> Purify
Background --> Gemini
Background --> Grok
Background --> Kimi
Background --> DeepSeek
Background --> ChatGPT
Background --> Qwen
Background --> Yuanbao
```

**图表来源**
- [manifest.json](file://manifest.json#L12-L32)
- [sidepanel.html](file://src/sidepanel/sidepanel.html#L13-L15)

### 内部模块依赖

```mermaid
graph TB
Background[background.js] --> Config[config.js]
Background --> I18n[i18n.js]
Background --> Popup[popup.js]
Background --> Sidepanel[sidepanel.js]
Content[content.js] --> Config
Content --> I18n
Popup --> Background
Sidepanel --> Background
Sidepanel --> Content
Popup --> Background
```

**图表来源**
- [background.js](file://src/background.js#L69-L74)
- [sidepanel.js](file://src/sidepanel/sidepanel.js#L395-L397)

**节来源**
- [manifest.json](file://manifest.json#L19-L69)

## 性能考虑

### 响应速度优化

系统通过以下机制优化响应速度：

1. **并行处理**：同时向多个AI模型发送消息
2. **智能等待**：根据模型特性调整等待时间
3. **缓存策略**：本地存储用户偏好设置
4. **延迟加载**：按需加载内容脚本

### 成本控制策略

1. **文件大小限制**：每文件10MB，总50MB限制
2. **重试机制**：最多3次重试，指数退避
3. **超时控制**：30秒上传超时
4. **资源清理**：及时释放文件对象URL

### 兼容性处理

系统采用多层次兼容性策略：

1. **选择器回退**：每个模型提供3-5个备用选择器
2. **平台特定优化**：针对不同平台的UI差异进行适配
3. **错误恢复**：网络错误和DOM变化的自动恢复
4. **版本兼容**：支持多个AI平台的版本升级

## 故障排除指南

### 常见问题诊断

#### 选择器失效

**症状**：无法找到输入框或发送按钮
**解决方案**：
1. 检查AI平台URL匹配
2. 更新选择器配置
3. 查看调试输出

#### 发送失败

**症状**：消息发送后无响应
**解决方案**：
1. 验证网络连接
2. 检查AI平台登录状态
3. 尝试不同的发送方法

#### 文件上传错误

**症状**：文件上传超时或失败
**解决方案**：
1. 检查文件大小限制
2. 验证文件类型支持
3. 重新尝试上传

### 调试工具

系统提供以下调试功能：

1. **选择器诊断**：自动检测并报告选择器状态
2. **响应提取**：手动提取AI平台的最新回复
3. **状态监控**：实时显示各模型的连接状态

**节来源**
- [background.js](file://src/background.js#L163-L296)
- [content.js](file://src/content/content.js#L127-L197)

## 结论

AI Multiverse Chat的模型选择机制通过配置驱动的设计实现了高度的灵活性和可扩展性。系统的核心优势包括：

1. **统一配置管理**：通过集中式配置简化了多平台支持
2. **智能选择策略**：提供直观的用户界面和状态同步
3. **强大的兼容性**：多层次的适配机制确保跨平台稳定性
4. **性能优化**：并行处理和智能等待机制提升用户体验

该系统为AI模型选择提供了坚实的技术基础，支持未来扩展更多AI平台和功能增强。通过持续的维护和社区贡献，该系统将继续演进以满足不断变化的需求。